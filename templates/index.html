<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <title>Weather</title>
</head>

<body>
    <nav
        class="text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:text-gray-400 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px">
            <li class="me-2">
                <a href="/"
                    class="inline-block p-4 text-blue-600 border-b-2 border-blue-600 rounded-t-lg active dark:text-blue-500 dark:border-blue-500"
                    aria-current="page">Clima reciente</a>
            </li>
            <li class="me-2">
                <a href="/registers"
                    class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300">Todos
                    los registros</a>
            </li>
            <li class="me-2">
                <a href="/alerts"
                    class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300">Alertas recientes</a>
            </li>
            <li class="me-2">
                <a href="/new-city"
                    class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300">Nueva
                    ciudad</a>
            </li>
        </ul>
    </nav>
    <div class="px-10 pt-4">
        <button id="fetchLastWeather" type="button"
            class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center">
            Actualizar clima de las ciudades
        </button>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 m-10">
        {{ if .weathers }}
        {{ range .weathers }}
        <div class="relative flex flex-col bg-gray-200 rounded p-4 w-full max-w-xs">
            <button id="deleteCity" data-city-id="{{ .ID }}" type="button" aria-label="delete" class="absolute top-2 right-2 inline-flex items-center justify-center w-8 h-8 rounded-full bg-white text-gray-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 shadow">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z" clip-rule="evenodd" />
                </svg>
            </button>
            <div class="font-bold text-xl">{{ .CityName }}</div>
            <div class="text-sm text-gray-500">{{ .FetchedAt }}</div>
            <div
                class="mt-6 text-6xl self-center inline-flex items-center justify-center rounded-lg text-indigo-400 h-24 w-24">
                <img src="{{ .IconURL }}" alt="{{ .Description }}" width="500" height="600">
            </div>
            <div class="flex flex-row items-center justify-center mt-6">
                <div class="font-medium text-6xl">{{ .TemperatureInCelsius }}°</div>
                <div class="flex flex-col items-center ml-6">
                    <div>{{ .Description }}</div>
                    <div class="mt-1">
                        <span class="text-sm"><i class="far fa-long-arrow-up"></i></span>
                        <span class="text-sm font-light text-gray-500">{{ .MaxTemperatureInCelsius }}°C</span>
                    </div>
                    <div>
                        <span class="text-sm"><i class="far fa-long-arrow-down"></i></span>
                        <span class="text-sm font-light text-gray-500">{{ .MinTemperatureInCelsius }}°C</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-row justify-between mt-6">
                <div class="flex flex-col items-center">
                    <div class="font-medium text-sm">Humedad</div>
                    <div class="text-sm text-gray-500">{{ .HumidityInPercentage }}%</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="font-medium text-sm">Presión</div>
                    <div class="text-sm text-gray-500">{{ .PressureInhPa }} hPa</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="font-medium text-sm">Visibilidad</div>
                    <div class="text-sm text-gray-500">{{ .VisibilityInKm }}km</div>
                </div>
            </div>
        </div>
        {{ else }}
        No hay nada
        {{ end }}
        {{ end }}
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>

        const fetchButton = document.getElementById('fetchLastWeather');

        fetchButton.addEventListener("click", (event) => {

            fetch("/fetch", {
                method: "GET",
            })
                .then(() => {
                    Toastify({
                        text: "Clima actualizado. Recargando...",
                        duration: 1000,
                        destination: "#",
                        newWindow: false,
                        close: false,
                        gravity: "top",
                        position: "right",
                        stopOnFocus: true,
                        style: {
                            background: "#FFA500",
                            color: "#000000",
                            'text-shadow': '2px 2px 5px white',
                        },
                        onClick: function () { }
                    }).showToast();

                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                })
                .catch(err => {
                    console.error("Error:", err);
                });
        })

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-city-id]');

            if (!btn) return;

            const id = btn.getAttribute('data-city-id');

            if (!id) return;

            if (!confirm('¿Eliminar ciudad? los registros y las alertas se mantendrán, pero no se generarán nuevas')) return;

            const formData = new FormData();

            formData.append("id", id);

            fetch('/delete-city', {
                method: 'DELETE',
                body: formData
            })
                .then(res => {
                    if (!res.ok) {
                        if (res.status === 400) {
                            return res.json().then(err => {
                                throw new Error(err.error || `Error ${res.status}`);
                            });
                        }
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.deleted) {

                        const card = btn.closest('.relative');
                        if (card) card.remove();

                        Toastify({
                            text: "Ciudad eliminada",
                            duration: 2000,
                            gravity: "top",
                            position: "right",
                            style: { background: "#FFA500", color: "#000" }
                        }).showToast();
                    } else {
                        Toastify({ text: "No se pudo eliminar", duration: 2000, style: { background: "#f00" } }).showToast();
                    }
                })
                .catch(err => {
                    console.error('Error al eliminar:', err);
                    Toastify({ text: "Error al eliminar", duration: 2000, style: { background: "#f00" } }).showToast();
                });
        });

        const checkCities = () => {
            fetch("/check-cities", {
                method: "GET",
            })
                .then(res => res.json())
                .then(data => {
                    if (data.no_records) {
                        Toastify({
                            text: "Sin registros. Creando registros de muestra...",
                            duration: 2000,
                            destination: "#",
                            newWindow: false,
                            close: false,
                            gravity: "top",
                            position: "right",
                            stopOnFocus: true,
                            style: {
                                background: "#FFA500",
                                color: "#000000",
                                'text-shadow': '2px 2px 5px white',
                            },
                            onClick: function () { }
                        }).showToast();

                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                });
        }

        checkCities();

    </script>
</body>

</html>